<mxfile host="65bd71144e">
    <diagram id="u04GzjvQo-12AX9q594g" name="第 1 页">
        <mxGraphModel dx="3269" dy="1667" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="4" value="&lt;div style=&quot;color: rgb(255, 255, 255); background-color: rgb(32, 40, 49); font-family: &amp;quot;jetbrains mono&amp;quot;, consolas, &amp;quot;courier new&amp;quot;, monospace; font-weight: normal; font-size: 16px; line-height: 22px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #55616c ; font-style: italic&quot;&gt;// PrepareRun prepares the aggregator to run, by setting up the OpenAPI spec and calling&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #55616c ; font-style: italic&quot;&gt;// the generic PrepareRun.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; (s &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;APIAggregator) &lt;/span&gt;&lt;span style=&quot;color: #ffc66d&quot;&gt;PrepareRun&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;() (preparedAPIAggregator, &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;error&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #55616c ; font-style: italic&quot;&gt;// add post start hook before generic PrepareRun in order to be before /healthz installation&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; s.openAPIConfig &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.GenericAPIServer.AddPostStartHookOrDie(&lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #3d8beb&quot;&gt;apiservice-openapi-controller&lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;(context genericapiserver.PostStartHookContext) &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;error&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;go&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; s.openAPIAggregationController.Run(context.StopCh)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; })&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; s.openAPIV3Config &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; utilfeature.DefaultFeatureGate.Enabled(features.OpenAPIV3) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.GenericAPIServer.AddPostStartHookOrDie(&lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #3d8beb&quot;&gt;apiservice-openapiv3-controller&lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;(context genericapiserver.PostStartHookContext) &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;error&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;go&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; s.openAPIV3AggregationController.Run(context.StopCh)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; })&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; prepared &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;:=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; s.GenericAPIServer.PrepareRun()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #55616c ; font-style: italic&quot;&gt;// delay OpenAPI setup until the delegate had a chance to setup their OpenAPI handlers&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; s.openAPIConfig &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; specDownloader &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;:=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; openapiaggregator.NewDownloader()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; openAPIAggregator, err &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;:=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; openapiaggregator.BuildAndRegisterAggregator(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;specDownloader,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.GenericAPIServer.NextDelegate(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.GenericAPIServer.Handler.GoRestfulContainer.RegisteredWebServices(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.openAPIConfig,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.GenericAPIServer.Handler.NonGoRestfulMux)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; err &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; preparedAPIAggregator{}, err&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.openAPIAggregationController &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; openapicontroller.NewAggregationController(&lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;specDownloader, openAPIAggregator)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; s.openAPIV3Config &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; utilfeature.DefaultFeatureGate.Enabled(features.OpenAPIV3) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; specDownloaderV3 &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;:=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; openapiv3aggregator.NewDownloader()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; openAPIV3Aggregator, err &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;:=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; openapiv3aggregator.BuildAndRegisterAggregator(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; specDownloaderV3,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.GenericAPIServer.NextDelegate(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.GenericAPIServer.Handler.NonGoRestfulMux)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; err &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; nil {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; preparedAPIAggregator{}, err&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s.openAPIV3AggregationController &lt;/span&gt;&lt;span style=&quot;color: #40bf77&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; openapiv3controller.NewAggregationController(openAPIV3Aggregator)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff92bb ; font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #ffffff&quot;&gt; preparedAPIAggregator{APIAggregator: s, runnable: prepared}, nil&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #ffffff&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=20;fontFamily=Architects Daughter;" vertex="1" parent="1">
                    <mxGeometry x="-469" y="-129" width="1375.33" height="1084.67" as="geometry"/>
                </mxCell>
                <mxCell id="5" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;sketch=0;hachureGap=4;fontFamily=Architects Daughter;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DArchitects%2BDaughter;fontSize=20;" vertex="1" parent="1">
                    <mxGeometry x="-616" y="-31" width="137" height="273" as="geometry"/>
                </mxCell>
                <mxCell id="7" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;sketch=0;hachureGap=4;fontFamily=Architects Daughter;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DArchitects%2BDaughter;fontSize=20;" vertex="1" parent="1">
                    <mxGeometry x="-621" y="351" width="137" height="530" as="geometry"/>
                </mxCell>
                <mxCell id="8" value="在 PSH 中去启动 OpenAPI Controller" style="text;strokeColor=none;fillColor=none;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;sketch=0;hachureGap=4;fontFamily=Lucida Console;fontSize=22;" vertex="1" parent="1">
                    <mxGeometry x="-1101" y="37" width="475" height="137" as="geometry"/>
                </mxCell>
                <mxCell id="9" value="制作一个 OpenAPI Controller，观测各个 Aggregated Server 所支持的 API 的变化，然后更新 Aggregator 自己的 OpenAPI Spec" style="text;strokeColor=none;fillColor=none;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;sketch=0;hachureGap=4;fontFamily=Lucida Console;fontSize=22;" vertex="1" parent="1">
                    <mxGeometry x="-1107" y="547.5" width="496" height="137" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>